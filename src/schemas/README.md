# schemas

## Purpose / Responsibilities

* Single source of truth for **data models and validation** across the AI Real Estate Deal Analyzer.
* Defines typed contracts for all agents, orchestrators, and core modules using **Pydantic v2** models.
* Ensures deterministic serialization/deserialization of inputs, forecasts, and reports.
* Enables safe interchange between deterministic and AI-assisted components.

## Public APIs / Contracts

* **Imports:**

  ```python
  from src.schemas.models import (
      FinancialInputs, OperatingExpenses, IncomeModel,
      FinancingTerms, FinancialForecast, YearBreakdown,
      PurchaseMetrics, InvestmentThesis, MarketSnapshot,
      MarketHypothesis, HypothesisSet, RegionalIncomeTable,
      RefiEvent, RunOptions, AppInputs
  )
  ```

### Core Models

| Model                 | Description                                                                                                                                                                                        |
| --------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **FinancialInputs**   | Root object containing all financing, income, and expense parameters. Serves as main input for `core/finance/engine.py`.                                                                           |
| **OperatingExpenses** | Yearly recurring costs. Fields: `insurance`, `taxes`, `repairs_maintenance`, `management`, `utilities`, `water_sewer`, `trash`, `snow_removal`, `hoa_fees`, `reserves`, `other`. All non-negative. |
| **IncomeModel**       | Rental and ancillary income definitions. Fields: `gross_rent`, `other_income`, `vacancy_rate` (fraction).                                                                                          |
| **FinancingTerms**    | Loan assumptions: `purchase_price`, `down_payment_rate`, `interest_rate`, `amort_years`, `io_years`, `mortgage_insurance_rate`, etc. All rates in **fractions [0–1]**.                             |
| **FinancialForecast** | Output from finance engine: yearly breakdown of net income, cash flow, equity, debt balance, appreciation, and IRR. Immutable.                                                                     |
| **YearBreakdown**     | Single-year snapshot inside forecast. Computed fields only.                                                                                                                                        |
| **PurchaseMetrics**   | Summary of acquisition economics: cash-on-cash return, DSCR, IRR, payback years.                                                                                                                   |
| **RefiEvent**         | Optional refinance parameters for scenario modeling. Not used in V1 orchestrator yet.                                                                                                              |
| **InvestmentThesis**  | Structured summary combining quantitative forecast and qualitative rationale. Generated by `agents/chief_strategist.py`.                                                                           |
| **RunOptions**        | Flags controlling orchestration behavior (e.g., LLM mode, debug, output paths).                                                                                                                    |
| **AppInputs**         | Container for structured runs with nested `FinancialInputs` and optional `RunOptions`.                                                                                                             |

### Market Models

| Model                   | Description                                                                                                                          |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| **MarketSnapshot**      | Baseline market state: `region`, `cap_rate`, `vacancy_rate`, `rent_growth`, `expense_growth`, `interest_rate`. All as **fractions**. |
| **MarketHypothesis**    | Delta adjustments (absolute % points) applied to snapshot fields; includes rationale and prior weight.                               |
| **HypothesisSet**       | Collection of `MarketHypothesis` with metadata, prior normalization, and determinism guarantees.                                     |
| **RegionalIncomeTable** | Deterministic summary of income distributions for regional comps (p25/median/p75, turnover, STR uplift flag).                        |

## Usage Examples

### Example 1 — Construct Financial Inputs

```python
from src.schemas.models import FinancialInputs, OperatingExpenses, FinancingTerms

financing = FinancingTerms(
    purchase_price=250000,
    down_payment_rate=0.05,
    interest_rate=0.045,
    amort_years=25,
    io_years=0,
    mortgage_insurance_rate=0.04
)

expenses = OperatingExpenses(
    insurance=1200, taxes=2600, repairs_maintenance=2000, management=1500
)

inputs = FinancialInputs(
    financing=financing,
    opex=expenses,
    income={"gross_rent": 24000, "vacancy_rate": 0.05}
)
print(inputs.model_dump_json(indent=2))
```

### Example 2 — Market Snapshot + Hypothesis Set

```python
from src.schemas.models import MarketSnapshot, MarketHypothesis, HypothesisSet

snap = MarketSnapshot(region="Metro A", cap_rate=0.055, vacancy_rate=0.06,
                      rent_growth=0.03, expense_growth=0.02, interest_rate=0.045)

deltas = [
    MarketHypothesis(rent_delta=0.02, expense_growth_delta=0.0,
                     interest_rate_delta=0.01, cap_rate_delta=0.0, vacancy_delta=-0.01, prior=0.25),
    MarketHypothesis(rent_delta=0.0, expense_growth_delta=0.0,
                     interest_rate_delta=0.0, cap_rate_delta=0.0, vacancy_delta=0.0, prior=0.5),
]
hs = HypothesisSet(items=deltas)
print(hs.summary())
```

## Design Notes / Invariants

* **Rates and percentages**: always expressed as fractions (e.g., `0.05` = 5%).
* **Currency**: all monetary fields in **consistent nominal currency**, no inflation adjustments in V1.
* **Immutability**: key models (`FinancialForecast`, `MarketSnapshot`, `HypothesisSet`) are frozen.
* **Validation rules**: enforced via Pydantic validators — all numeric inputs must be non-negative.
* **Serialization**: deterministic order via field definitions; stable across runs.
* **Backward compatibility**: legacy `FinancialInputs` accepted directly for V1 deterministic runs; `AppInputs` supports structured runs for future LLM orchestration.

## Dependencies / Optional Providers

* No runtime dependencies beyond **Pydantic v2**.
* Consumed by: `core/finance`, `agents`, `orchestrators`, `tools`, `market`, and `reports`.
* Optional LLM or AI components may enrich `InvestmentThesis` text fields.

## Test Strategy

* Unit tests under `tests/unit/test_schemas_models.py` and indirectly in all domain tests.
* Focus: field validation, serialization stability, and numeric rounding behavior.
* Run:

  ```bash
  pytest -q tests/unit/test_schemas_models.py
  ```

## Cross-links

* Back to [Main README](../README.md)
* Related folders:

  * [`../core/README.md`](../core/README.md)
  * [`../market/README.md`](../market/README.md)
  * [`../agents/README.md`](../agents/README.md)
  * [`../orchestrators/README.md`](../orchestrators/README.md)
  * [`../reports/README.md`](../reports/README.md)
  * [`../tools/README.md`](../tools/README.md)
  * [`../inputs/README.md`](../inputs/README.md)

## Change Log Notes (scoped)

* Added `AppInputs` and `RunOptions` for LLM orchestration.
* Introduced frozen dataclasses for forecast and market models to ensure determinism.
* Consolidated legacy `FinancialInputs` and structured inputs under a unified Pydantic schema.
